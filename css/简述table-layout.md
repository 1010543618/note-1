之前的[文章](./table的那些坑.md)已经提到了给 `<table>` 的设置样式时有许多难以预测的行为, 究其原因是浏览器渲染表格时默认采用的是**自动表格布局(Automatic table layout)**算法. 我们都知道浏览器解析 HTML 是自上往下的, 那浏览器是怎么渲染 `<table>` 的呢?



#### 自动表格布局

自动表格布局是浏览器渲染表格时的默认算法(其实也说不定), 对应的情况是对 `<table>` 设置了 `table-layout: auto;` . 但其实 CSS 标准中并没有规定 `table-layout: auto;` 时一定要使用该算法, 而是说浏览器也可以使用其他的算法, 所以该算法准确说只是 `table-layout: auto;` 的一种实现.

在自动表格布局的算法下, 每列的宽度根据以下步骤确定:

1. 计算每个单元格(cell)的**最小内容宽度(MCW)**. 最小内容宽度是格式化后的内容(formatted content, 什么是格式化后的内容)的宽度. 格式化后的内容可能会换行, 跨越多行, 但是一定不会溢出单元格. 如果单元格指定了 `width` 后比 MCW 大, 则把这个 `width` 的宽度视为单元格的**最小单元格宽度(minimum cell width)**. 如果单元格为 `width: auto;` 则 MCW 是最小单元格宽度. 再计算每个单元格的**最大单元格宽度(maximum cell width)** . 最大单元格宽度是指单元格内容没有换行时的宽度. 翻译有点渣, 总的来说, 这一条说的是, 先计算了所有单元格的最小宽度和最大宽度.
2. 对于每一列, 根据只占该列的单元格(即排除掉跨越多列的单元格)来确定该列的最大宽度和最小宽度: 最小宽度是所有符合条件的单元格的最小单元格宽度以及对应 `<col>` 的 `width` 最大的那一个, 最大宽度是所有符合条件的单元格的最大单元格宽度以及对应 `<col>` 的 `width` 最大的那一个. MMP 这句话真是绕, 翻译成人话是: 设只占该列的单元格的集合为 C, 该列对应的 `<col>` 的 `width` 为 CW. 规则 1 定义了最小单元格宽度算法 MINW 和最大单元格宽度算法 MAXW, 集合 A = {a | a = MINW(c), c 属于 C}, 集合 B = {b | b = MAXW(c), c 属于 C}, 则列的最小宽度 = max(a1, a2, ... an, CW), 列的最大宽度 = max(b1, b2, ... bn, CW).
3. 对于那些跨越多列的单元格, 增加它所在的那些列的最小宽度, 使得这些列的最小宽度的和大于等于该单元格的最小单元格宽度(假如该列有多个跨越多列的单元格, 这个步骤应该会重复多次直到不小于最大的那个单元格); 同理, 增加它所在的那些列的最大宽度, 使得这些列的最大宽度的和大于等于该单元格的最大单元格宽度. 如果可能的话, 尽可能使每个列增加的宽度一样.
4. 对于每个 `width` 不为 `auto` 的 `<colgroup>`, 增加它对应的那些列的最小宽度, 使得它们的和大于等于 `<colgroup>` 的 `width`.


简单来说, 规则 1 确定了每个单元格的最小宽度和最大宽度, 规则 2 根据每列上非跨越多列的单元格的最小宽度和最大宽度确定了列的最小宽度和最大宽度, 规则 3 根据跨越多列的单元格调整了每列的最小宽度和最大宽度, 规则 4 根据 `<colgroup>` 的宽度调整了每列的最小宽度. 其实扯这么多翻译又累, 浏览器还不一定用的是上面的算法...具体参考 http://w3help.org/zh-cn/causes/RE8001.

不过所有浏览器的共同点是, 浏览器需要读完所有 `<td>` 的内容, 才能确定每列的宽度. 并且浏览器会确保 `<td>` 的内容不会溢出 `<td>`.



#### 固定表格布局

要使用固定表格布局, 只需要对 `<table>` 设置 `table-layout: fixed;` . 固定表格布局算法比自动表格布局算法更快. 表格在水平方向上的布局方式不取决于每个单元格的内容, 而是只取决于表格的 `width`, `<col>` 的 `width`, 单元格及表格 `border` 的宽度, 和 `border-spacing`.

在使用该布局时, **必须指定 `<table>` 的 `width`.** 如果没有指定 `width` 或者是 `width: auto;`, 则默认使用自动表格布局, 即认为 `table-layout: fixed` 无效.

在固定表格布局算法下, 每一列的宽度根据以下步骤确定:

1. 由 `width` 的值不是 `auto` 的列元素(column element)来设置该列的宽度. 列元素即 `<col>` 或者说 `display: table-column;` 的元素. 这句话的意思是, 如果对某个 `<col>` 设置了 `width`, 则那一列的宽度就由这个 `<col>` 确定(可以简单理解为那一列的宽度就是 `<col>` 的宽度).
2. 否则, 如果该列的第一行的单元格的 `width` 不为 `auto`, 则该列的宽度由该列第一行的单元格确定(可以简单理解为该列宽度就是该列第一行的 `<td>` 宽度). 如果该列第一行的单元格跨越多列, 则将该单元格宽度均分到这些列上, 即这些列的宽度都由这个单元格确定.
3. 剩下的列(没有对应 `<col>` 确定宽度且第一行的单元格也没有设置具体的 `width` 的列)均分表格横向的剩余空间, 剩余空间是指*表格的宽度*减去 `border` 和 `border-spacing` 之后的宽度. 表格的宽度是指 `<table>` 的 `width` 和列宽度的总和(`<col>` 的宽度加上 `border` `border-spacing`)中较大的那个. 如果表格的 `width` 大于列宽度的总和, 则多出来的空间被均分到列上(即列的实际宽度比对 `<col>` 设置的宽度大).

简单的翻译成人话, 就是每列的宽度由对应的 `<col>` 的宽度确定; 如果没有对应的 `<col>` 则由该列第一行的 `<td>` 元素的 `width` 确定(值不为 `auto`); 如果第一行的 `<td>` 跨多列, 则这些列均分这个 `<td>` 的宽度; 其他既没有对应 `<col>` 又没有固定宽度的第一行 `<td>` 的列均分剩余空间.

在这种布局算法下, 浏览器解析完表格第一行内容, 就可以对表格进行布局, 而不需要等到解析完整个 `<table>` 内容, 因此性能上比自动表格布局更好. 并且单元格的内容也不会影响每列的宽度, 可以通过 `overflow` 来控制单元格内容溢出的方式.



#### 总结

以上两个算法的主要区别有以下几点:

* 自动表格布局需要读完 `<table>` 的所有内容才能渲染, 效率较低; 固定表格布局只需要读完表格第一行的内容即可渲染表格, 效率较高.
* 自动表格布局中, `<td>` 的内容肯定不会溢出, 固定表格布局中, `<td>` 内容可能会溢出, 需要自己通过 `overflow` 控制.

总的来说根据自己需要选择合适的表格布局方式吧, 不过一般情况为了让表格的行为更加可预测一些, 可以考虑 `table-layout: fixed;`



#### 参考资料

* https://www.w3.org/TR/CSS2/tables.html#auto-table-layout
* http://w3help.org/zh-cn/causes/RE8001
* http://w3help.org/zh-cn/causes/RE1011
* https://x-front-team.github.io/2017/04/25/table-layout%E7%90%86%E8%A7%A3%E5%88%B0%E6%94%BE%E5%BC%83/
* https://developer.mozilla.org/en-US/docs/Learn/CSS/Styling_boxes/Styling_tables
* https://css-tricks.com/fixing-tables-long-strings/

